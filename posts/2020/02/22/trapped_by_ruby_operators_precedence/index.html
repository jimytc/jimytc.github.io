<!doctype html><html lang=en><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="public"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.64.1"><title>Trapped by Ruby Operators Precedence • Jim Chen</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Trapped by Ruby Operators Precedence"><meta name=twitter:description content="Let the story begin I started to work on a new production code repository, and I could tell my productivity degraded for almost 7 workdays. But this was not because of my lack of domain knowledge in the new production code nor the new development environment and configuration."><meta property="og:title" content="Trapped by Ruby Operators Precedence"><meta property="og:description" content="Let the story begin I started to work on a new production code repository, and I could tell my productivity degraded for almost 7 workdays. But this was not because of my lack of domain knowledge in the new production code nor the new development environment and configuration."><meta property="og:type" content="article"><meta property="og:url" content="https://jimytc.com/posts/2020/02/22/trapped_by_ruby_operators_precedence/"><meta property="article:published_time" content="2020-02-22T21:50:00+08:00"><meta property="article:modified_time" content="2020-02-22T21:50:00+08:00"><meta property="og:site_name" content="Backend Engineer"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><link rel=stylesheet href=/scss/hyde-hyde.92c66d107d7b219f0792cfd67223179af884b03f386ac46894f9f735932bbca3.css integrity="sha256-ksZtEH17IZ8Hks/WciMXmviEsD84asRolPn3NZMrvKM="><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-0a><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://jimytc.com/>Jim Chen</a></span><div class=author-image><img src=https://jimytc.com/images/author-photo.jpg alt="Author Image" class="img--circle img--headshot element--center"></div><p class=site__description>a.k.a. jimytc</p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>Jim Chen</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li><li><a href=/categories/><span>Categories</span></a></li></ul></div><section class=social><a href=https://twitter.com/jimytc rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a><a href=https://facebook.com/jim.yenting rel=me><i class="fab fa-facebook-f"></i></a><a href=https://github.com/jimytc rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a><a href=https://instagram.com/jimytc rel=me><i class="fab fa-instagram fa-lg" aria-hidden=true></i></a><a href=https://linkedin.com/in/yentingchen rel=me><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a><a href=https://stackoverflow.com/users/2728942/jimytc rel=me><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a></section></div></div><div class=copyright>&copy; 2020 jimytc
<a href=https://creativecommons.org/licenses/by-sa/4.0>CC BY-SA 4.0</a></div><div class=builtwith>Built with <a href=https://gohugo.io>Hugo</a> ❤️ <a href=https://github.com/htr3n/hyde-hyde>hyde-hyde</a>.</div></div></div><div class="content container"><article><header><h1>Trapped by Ruby Operators Precedence</h1><div class=post__meta><i class="fas fa-calendar-alt"></i>Feb 22, 2020
in
<a class="badge badge-category" href=/categories/engineering>ENGINEERING</a><br><i class="fas fa-tags"></i><a class="badge badge-tag" href=/tags/ruby>ruby</a>
<a class="badge badge-tag" href=/tags/troubleshooting>troubleshooting</a>
<a class="badge badge-tag" href=/tags/operators-precedence>operators precedence</a><br><i class="fas fa-clock"></i>3 min read</div></header><div class=post><h2 id=let-the-story-begin>Let the story begin</h2><p>I started to work on a new production code repository, and I could tell my productivity degraded for almost 7 workdays. But this was not because of my lack of domain knowledge in the new production code nor the new development environment and configuration. Even though I had some issues and was unfamiliar, I still deliver several items.</p><p>It was the inability to do development and run test all in my most familiar IDE. To workaround this, I had to go back and forth between my IDE and terminal to run my test command.</p><h2 id=observations-and-the-fix>Observations and the fix</h2><p>I got two from my investigation. The first one was obvious => the error. It was an unexpected outgoing network request when running test with my IDE. (We don&rsquo;t want test has dependencies on network.) The other was the different commands for tests. In terminal, I used <code>bundle exec rails test &lt;test_file></code> and my IDE uses <code>ruby -Itest &lt;test_file></code>.</p><p>So simple thing first, could I reproduce it with the same command from my IDE? And the answer was yes. Great, I got consistency in both environments. Different commands may lead to the differences in the flow of the commands. But let me go into the error one which is more likely a human error.</p><p>Guess what. It&rsquo;s caused by a network library initialization wrapped by a guard condition. Like below.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#66d9ef>if</span> defined? <span style=color:#66d9ef>NET_TOOL</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>env<span style=color:#f92672>.</span>test? <span style=color:#75715e># &lt;= The guard does not work</span>
  <span style=color:#75715e># DO the initialization</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Changing it to the code below fixed the problem!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>env<span style=color:#f92672>.</span>test? <span style=color:#f92672>&amp;&amp;</span> defined?(<span style=color:#66d9ef>NET_TOOL</span>)
  <span style=color:#75715e># DO the initialization</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><h3 id=boom>Boom!!</h3><h2 id=what-happened>What happened?</h2><p>This is something about Ruby&rsquo;s operator precedence. You can refer the post <a href=https://ruby-doc.org/core-2.7.0/doc/syntax/precedence_rdoc.html>here</a>.</p><p>The original guard condition is,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>defined? <span style=color:#66d9ef>NET_TOOL</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>env<span style=color:#f92672>.</span>test?<span style=color:#e6db74>`</span><span style=color:#e6db74>
</span></code></pre></div><p>With which we want it to be.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>defined?(<span style=color:#66d9ef>NET_TOOL</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>env<span style=color:#f92672>.</span>test?<span style=color:#e6db74>`</span><span style=color:#e6db74>
</span></code></pre></div><p>However, the <code>&&</code> operator has higher order than <code>defined?</code>, so the expression actually becomes <code>defined?(NET_TOOL && !Rails.env.test?)</code>.</p><p>Further, <code>NET_TOOL</code> namespace exists and <code>!Rails.env.test?</code> is <code>false</code> in testing. The code will be recognized as <code>defined?(false)</code> and it returns a <code>"expression"</code> string.</p><p>In Ruby, if-statement cares about falsy and truthy, not the boolean value, <code>true</code> and <code>false</code>.
Truthy means values that are not <code>nil</code> or <code>false</code>. Therefore, our original if-statement always gets a truthy value. And as a result, it always does the initialization.</p><p>Pretty interesting, huh?</p><h2 id=thoughts>Thoughts</h2><p>I believe that the entire effort would never be reduced. It&rsquo;s just moved to somewhere else. Like my story, Ruby allows us to ignore parenthesis but that also makes expression evaluation implicit. To make the program runs as we think, we have to be aware of those implicit rules.</p><p>Maybe there are some better pattern to live with no-parenthesis style. If you know, please let me know. I really want to learn that. But before that, I would suggest using parenthesis to reduce the chance that the code runs differently from we think.</p><h3 id=another-mysterious-thing-to-dive-into-but-not-this-time>Another mysterious thing to dive into but not this time.</h3><p>Remember the two different commands? That would be another story about what <code>rails</code> does and how it makes different from <code>ruby</code>.</p></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname===""){return;}
var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='jimytc-github-io';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by
<span class=logo-disqus>Disqus</span></a></article></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-9646591-7','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script defer src=https://use.fontawesome.com/releases/v5.5.0/js/all.js integrity=sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>